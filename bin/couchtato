#!/usr/bin/env node

var fs = require('fs'),
    path = require('path'),
    Conf = require('../lib/conf').Conf,
    Couchtato = require('../lib/couchtato').Couchtato,
    args = process.argv.slice(2),
    base = process.cwd(),
    conf = new Conf(),
    confFile = path.join(base, 'couchtato.js'),
    usage, conf, options, couchtato, doInit, doIterate;

usage = 'Usage: couchtato [options]\n'
    + '\n'
    + 'Options:\n'
    + '  -f, --file     Configuration file\n'
    + '  -u, --url      CouchDB URL http(s)://host:port/path\n'
    + '  -p, --pagesize The number of documents per page\n'
    + '  -h, --help     Display help info\n';
    
abort = function (message) {
    console.error(message);
    process.exit(1);
};

while (args.length) {
    var arg = args.shift();
    switch (arg) {
        case 'init':
            args.action = arg;
            break;
        case '-f':
        case '--file':
            args.length
                ? (args.file = path.join(process.cwd(), args.shift()))
                : abort('--file requires an argument');
            break;
        case '-u':
        case '--url':
            args.length
                ? (args.url = args.shift())
                : abort('--url requires an argument');
            break;
        case '-p':
        case '--pagesize':
            args.length
                ? (args.pageSize = parseInt(args.shift()))
                : abort('--pageSize requires an argument');
            break;
        case '-h':
        case '--help':
            abort(usage);
            break;
    }
}

doInit = function () {
    conf.init(args.file || confFile);
};

doIterate = function () {
    options = {
        url: args.url,
        tasks: conf.read(args.file || confFile).tasks,
        pageSize: args.pageSize || 500,
        encoding: 'utf-8'
    };
    couchtato = new Couchtato(options);
    couchtato.iterate();
};

switch (args.action) {
    case 'init':
        doInit();
        break;
    case undefined:
        doIterate();
        break;
}